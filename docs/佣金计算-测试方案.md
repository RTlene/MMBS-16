# 佣金计算流程 - 测试方案

本方案覆盖《佣金计算逻辑说明》中的计算触发、四种订单佣金、确认/取消、团队拓展激励及与提现的衔接，适用于手工测试或作为自动化用例设计依据。

---

## 一、测试范围与目标

| 范围 | 说明 |
|------|------|
| 订单佣金计算 | 无推荐人 / 直接 / 间接 / 分销商 / 网络分销商，触发时机与结果落库 |
| 比例与优先级 | 等级比例 vs 个人覆盖（personal*Rate），零比例与边界 |
| 确认与取消 | 单条确认后余额变化，取消后状态与不再入账 |
| 团队拓展激励 | 按月触发、销售额区间、激励金额与落库 |
| 与支付/订单联动 | 支付成功触发计算、重复计算与幂等、退款/取消订单对佣金的影响（若实现） |
| 与提现衔接 | 确认入账 → 可用佣金 → 提现申请 → 冻结/可用变化 |

---

## 二、环境与数据准备

### 2.1 基础数据

- **会员等级（member_levels）**  
  - 至少两个：一个 `isSharingEarner = false`（不参与分享佣金），一个 `isSharingEarner = true`，并设置 `directCommissionRate`、`indirectCommissionRate`（如 10、5）。  
  - 用于验证：仅“分享赚钱”等级才产生直接/间接佣金。

- **分销等级（distributor_levels）**  
  - 至少两个等级，不同 `costRate`（如 60、70），用于分销商佣金与网络分销商成本差。  
  - 可选：`directCommissionRate`、`indirectCommissionRate` 若业务使用则一并配置。

- **团队拓展等级（team_expansion_levels）**  
  - 设置 `minIncentiveBase`、`maxIncentiveBase`（如 1000、50000）、`incentiveRate`（如 1）。  
  - 用于团队拓展激励用例。

- **会员（members）**  
  - **买家 A**：无推荐人（`referrerId = null`）。  
  - **买家 B**：`referrerId = 推荐人C`。  
  - **推荐人 C**：`memberLevelId` = 分享赚钱等级，`referrerId = 间接推荐人D`，`distributorLevelId = null`。  
  - **间接推荐人 D**：`memberLevelId` = 分享赚钱等级，`referrerId = null`。  
  - **分销商 E**：`distributorLevelId` = 某分销等级（costRate=60），`referrerId = null` 或 F。  
  - **分销商 F**（链上更高层）：`distributorLevelId` = 另一分销等级（costRate=70），用于网络分销“多分销商”场景。  
  - **推荐人 G**：仅用于团队拓展，`teamExpansionLevelId` 已设；其下属为分销商（如 E），E 当月有已支付订单。

- **商品与订单**  
  - 可支付商品、可创建并支付成功的订单（小程序下单或后台/支付回调），订单金额建议固定（如 100 元），便于手工算预期佣金。

### 2.2 接口与权限

- 后台需管理员 Token：`Authorization: Bearer <token>`。  
- 佣金相关接口：  
  - `GET /api/commission/calculations` — 计算记录列表（筛 type、status、memberId、日期）。  
  - `POST /api/commission/calculate/:orderId` — 手动触发订单佣金计算。  
  - `PUT /api/commission/confirm/:id` — 确认单条计算（id 为 CommissionCalculation.id）。  
  - `PUT /api/commission/cancel/:id` — 取消单条计算。  
  - `POST /api/commission/calculate-team-incentive` — 触发团队拓展激励（body: `{ month: 'YYYY-MM' }`）。  
  - `GET /api/commission/team-incentives` — 团队激励计算记录。  
  - `GET /api/commission/stats` — 统计（总数、待确认、已确认、已确认总金额）。  
- 会员余额：通过会员详情或会员列表接口查看 `availableCommission`、`totalCommission`、`frozenCommission`。  
- 订单支付：按现有流程（小程序下单+支付或模拟支付回调）使订单变为 `paid`。

---

## 三、用例设计

### 3.1 前置与触发

| 用例编号 | 场景 | 步骤 | 预期 |
|----------|------|------|------|
| T-1 | 无推荐人不计算 | 1. 买家 A（无 referrerId）下单并支付成功<br>2. 查询该订单的 commission_calculations 或调用 GET /api/commission/calculations 筛该订单 | 无该订单的佣金计算记录；或 calculateOrderCommission 不抛错且返回空 |
| T-2 | 支付成功触发计算 | 1. 买家 B（推荐人 C，C 为分享赚钱）下单并支付<br>2. 查询 commission_calculations 或列表筛 orderId | 该订单下出现至少 1 条 direct 类型、recipientId=C、status=pending、commissionAmount=订单额×C 的直接佣金比例 |
| T-3 | 手动触发同一订单 | 1. 对 T-2 的订单再调 POST /api/commission/calculate/:orderId<br>2. 再查该订单佣金记录 | 注意：当前实现可能重复插入；预期要么幂等（不重复）要么文档说明“会重复计算”，按实际设计验证 |

### 3.2 直接佣金

| 用例编号 | 场景 | 数据与步骤 | 预期 |
|----------|------|------------|------|
| T-4 | 分享赚钱 + 等级比例 | 买家 B，推荐人 C（memberLevel.isSharingEarner=true，directCommissionRate=10），订单 100 元，支付后查计算记录 | 1 条 direct，recipientId=C，commissionRate=10，commissionAmount=10，status=pending |
| T-5 | 个人覆盖等级比例 | 同上，且 C.personalDirectCommissionRate=15 | 1 条 direct，commissionRate=15，commissionAmount=15 |
| T-6 | 非分享赚钱不产生直接佣金 | C 的 memberLevel.isSharingEarner=false，其他同 T-4 | 该订单无 direct 类型记录（或 C 不出现为 recipient 的 direct） |
| T-7 | 直接佣金比例为 0 | C 的等级 directCommissionRate=0（且无个人覆盖） | 无 direct 记录 |

### 3.3 间接佣金

| 用例编号 | 场景 | 数据与步骤 | 预期 |
|----------|------|------------|------|
| T-8 | 二级推荐人分享赚钱 | 买家 B → 推荐人 C → 间接推荐人 D，C、D 均为 isSharingEarner，D.indirectCommissionRate=5，订单 100 元 | 1 条 indirect，recipientId=D，commissionRate=5，commissionAmount=5，status=pending |
| T-9 | 间接推荐人非分享赚钱 | D.isSharingEarner=false | 无 indirect 记录 |
| T-10 | 无二级推荐人 | C.referrerId=null | 无 indirect 记录 |
| T-11 | 个人间接比例覆盖 | D.personalIndirectCommissionRate=8 | indirect 的 commissionRate=8，commissionAmount=8 |

### 3.4 分销商佣金

| 用例编号 | 场景 | 数据与步骤 | 预期 |
|----------|------|------------|------|
| T-12 | 推荐人为分销商 | 买家 B，推荐人 C 为分销商（distributorLevel.costRate=60），订单 100 元 | 1 条 distributor，recipientId=C，costRate=60，costAmount=60，commissionAmount=40（100-60），status=pending |
| T-13 | 个人成本率覆盖 | C.personalCostRate=70 | costAmount=70，commissionAmount=30 |
| T-14 | 成本率为 0 | costRate=0 | 不生成 distributor（或 commissionAmount 按当前实现验证） |

### 3.5 网络分销商佣金

| 用例编号 | 场景 | 数据与步骤 | 预期 |
|----------|------|------------|------|
| T-15 | 链上仅一个分销商 | 买家 B → 推荐人 C（非分销）→ 无更上层；或 B → C（分销，costRate=60）且 C 以上无分销商 | 1 条 network_distributor，recipientId=该分销商，佣金=订单额−成本额（按该分销商 costRate） |
| T-16 | 链上多分销商（成本差） | B → C（非分销）→ 分销商 E（costRate=60）→ 分销商 F（costRate=70）。最近分销商为 E，其他为 F。 | 1 条 network_distributor，recipientId=E；比例=60−70=-10≤0 则不生成；若链顺序为 F→E 则 E 为最近，比例=60−70 仍≤0。需按代码“最近”定义选链：若最近为 E、其他含 F，则差=60-70 为负，不生成；若最近为 F、其他含 E，则差=70-60=10，commissionAmount=10 |
| T-17 | 仅一个分销商无其他 | 链上只有 E（costRate=60） | network_distributor，recipientId=E，佣金=100-60=40（同 T-15 单分销逻辑） |

说明：T-16 需根据 `findNearestDistributorInNetwork` 从 referrer 向上找“最近”的语义，确认谁为最近、谁为 other，再定预期。

### 3.6 同单多类型并存

| 用例编号 | 场景 | 数据与步骤 | 预期 |
|----------|------|------------|------|
| T-18 | 直接+间接+分销商 | 买家 B → C（分享赚钱+分销商）→ D（分享赚钱），订单 100 元，C 直接 10%、D 间接 5%、C 成本率 60% | 3 条：direct recipient C 10 元；indirect recipient D 5 元；distributor recipient C 40 元；均为 pending |

### 3.7 确认与取消

| 用例编号 | 场景 | 步骤 | 预期 |
|----------|------|------|------|
| T-19 | 确认单条计算 | 对 T-4 产生的 direct 记录调 PUT /api/commission/confirm/:id；查会员 C 的 availableCommission、totalCommission | 该条 status=confirmed；C 的 availableCommission 与 totalCommission 各 +10（或对应金额） |
| T-20 | 取消单条计算 | 对另一条 pending 调 PUT /api/commission/cancel/:id | 该条 status=cancelled；对应会员余额不变 |
| T-21 | 重复确认 | 对已 confirmed 的记录再调 confirm | 按实现：要么 400/409，要么幂等（不重复加余额）；需验证不会双倍加钱 |
| T-22 | 确认不写 MemberCommissionRecord | 确认一条订单佣金后查 member_commission_records 筛该会员 | 无新增 record（当前设计如此）；管理员调整才有 record |

### 3.8 团队拓展激励

| 用例编号 | 场景 | 数据与步骤 | 预期 |
|----------|------|------------|------|
| T-23 | 月份与销售额统计 | 分销商 E，E.referrerId=G，G.teamExpansionLevelId 已设，minIncentiveBase=1000，maxIncentiveBase=50000，incentiveRate=1；E 在 2025-01 有已支付订单总金额 2000 元 | POST /api/commission/calculate-team-incentive { month: '2025-01' }；GET team-incentives 筛 2025-01；存在一条 distributorId=E、referrerId=G、monthlySales=2000、incentiveAmount=20、status=pending |
| T-24 | 销售额低于下限 | 同上，E 当月销售额 500 | 无该分销商在当月的团队激励记录（或该条被跳过） |
| T-25 | 销售额高于上限 | maxIncentiveBase=1000，E 当月 2000 | 无该分销商当月的激励记录（或跳过） |
| T-26 | 分销商无推荐人 | E.referrerId=null | 无 E 的团队激励记录 |
| T-27 | 推荐人无团队拓展等级 | G.teamExpansionLevelId=null | 无 E 的团队激励记录 |
| T-28 | 当月无支付订单 | E 在 2025-02 无 paid 订单 | 无 2025-02 的 E 的激励记录 |

### 3.9 与支付/订单的联动

| 用例编号 | 场景 | 步骤 | 预期 |
|----------|------|------|------|
| T-29 | 仅已支付订单参与计算 | 订单为 pending/created，未支付；手动 POST calculate/:orderId 或先支付再查 | 未支付订单：若接口允许传 orderId，则计算内会取 order.totalAmount，但业务上应只对 paid 触发；支付成功后该订单才应有佣金记录（与 T-2 一致） |
| T-30 | 订单金额与 totalAmount | 订单实付 100（或 totalAmount=100），推荐人直接 10% | 计算记录 orderAmount=100，commissionAmount=10 |

### 3.10 与提现的衔接（可选）

| 用例编号 | 场景 | 步骤 | 预期 |
|----------|------|------|------|
| T-31 | 确认后可用于提现 | 确认若干条佣金，会员 availableCommission=50；小程序提交提现 30 | 提现申请成功；该会员 availableCommission=20，frozenCommission=30 |
| T-32 | 拒绝提现回可用 | 上步提现被拒绝 | frozenCommission 减 30，availableCommission 加 30 |
| T-33 | 转账撤回回可用 | 提现通过后执行转账撤回 | 提现记录取消，frozenCommission 减、availableCommission 加回对应金额 |

---

## 四、检查点汇总

- **commission_calculations**：orderId、memberId、referrerId、recipientId、commissionType、orderAmount、commissionRate、commissionAmount、costRate/costAmount（若有）、status、calculationDate。  
- **Member**：availableCommission、totalCommission、frozenCommission 在确认、取消、提现、拒绝、撤回后的变化。  
- **member_commission_records**：仅管理员调整应有新记录；订单佣金确认不写（当前逻辑）。  
- **team_incentive_calculations**：calculationMonth、distributorId、referrerId、monthlySales、incentiveRate、incentiveAmount、status。

---

## 五、建议执行顺序

1. 准备等级与会员（T-1～T-7 直接佣金）。  
2. 间接、分销、网络分销（T-8～T-17）。  
3. 组合场景与确认/取消（T-18～T-22）。  
4. 团队拓展（T-23～T-28）。  
5. 支付联动与金额（T-29～T-30）。  
6. 提现衔接（T-31～T-33，若测提现）。

---

## 六、自动化建议

- **接口层**：对 POST /api/commission/calculate/:orderId、PUT /api/commission/confirm/:id、PUT /api/commission/cancel/:id、POST /api/commission/calculate-team-incentive 做参数与状态码、响应体的断言。  
- **数据层**：在测试库中准备固定会员与等级，下单并支付后断言 commission_calculations 条数、类型、金额、recipientId；确认后断言 Member.availableCommission/totalCommission。  
- **幂等与重复**：同一订单多次 calculate 的预期（是否允许重复插入）需与产品/开发约定后写入用例与脚本。

---

以上方案覆盖《佣金计算逻辑说明》中的计算流程；若业务后续调整（如自动确认、退款回滚佣金等），需同步增补用例与数据准备。
