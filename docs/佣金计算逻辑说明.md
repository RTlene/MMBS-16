# 系统佣金计算逻辑说明

本文档根据当前代码整理，描述佣金计算、入账与提现的完整流程。

---

## 一、佣金体系概览

| 类型 | 说明 | 计算基数 | 比例来源 | 入账方式 |
|------|------|----------|----------|----------|
| **直接佣金** | 下单用户的直接推荐人获得 | 订单金额 `order.totalAmount` | 会员等级 `directCommissionRate` 或个人覆盖 `personalDirectCommissionRate` | 见下文「入账与确认」 |
| **间接佣金** | 推荐人的推荐人（二级）获得 | 订单金额 | 会员等级 `indirectCommissionRate` 或个人 `personalIndirectCommissionRate` | 同上 |
| **分销商佣金** | 推荐人本人为分销商时，按成本差获得 | 订单金额 | 分销等级 `costRate`（提货成本%），佣金 = 订单额 - 成本额 | 同上 |
| **网络分销商佣金** | 推荐链上最近分销商获得 | 订单金额 | 单分销商：成本率；多分销商：最近分销商成本率 - 网络中其他最高成本率 | 同上 |
| **团队拓展激励** | 分销商的推荐人按下属分销商月销售额获得 | 分销商当月销售额 | 团队拓展等级 `incentiveRate`、`minIncentiveBase`、`maxIncentiveBase` | 单独按月计算，需手动触发 |

会员身份与等级：

- **分享赚钱**：`MemberLevel.isSharingEarner === true` 时，才参与直接/间接佣金（作为推荐人或二级推荐人）。
- **分销商**：`Member.distributorLevelId` 不为空时为分销商，参与分销商佣金、网络分销商佣金；其推荐人可参与团队拓展激励。

---

## 二、触发时机

### 2.1 订单佣金（直接 / 间接 / 分销商 / 网络分销商）

- **触发点**：订单支付成功时。
- **代码位置**：`routes/miniapp-order-routes.js` 中，订单状态更新为 `paid` 后调用：
  ```js
  await CommissionService.calculateOrderCommission(order.id);
  ```
- **手动触发**：后台可调用 `POST /api/commission/calculate/:orderId` 对指定订单重新计算（需登录）。

### 2.2 团队拓展激励

- **触发点**：不随订单自动执行，需后台**手动触发**。
- **接口**：`POST /api/commission/calculate-team-incentive`，body 传 `{ month: 'YYYY-MM' }`。
- **逻辑**：按指定月份统计各分销商的销售额，再根据其推荐人的团队拓展等级（`minIncentiveBase`、`maxIncentiveBase`、`incentiveRate`）计算激励金额，写入 `TeamIncentiveCalculation`。

---

## 三、订单佣金计算流程（calculateOrderCommission）

入口：`services/commissionService.js` → `calculateOrderCommission(orderId)`。

1. **前置条件**
   - 订单存在且有关联会员（下单用户）。
   - 下单用户有推荐人：`member.referrerId` 不为空。
   - 若无推荐人，直接返回，不生成任何佣金。

2. **推荐链**
   - **推荐人** = 下单用户的 `referrerId` 对应会员（含 `memberLevel`、`distributorLevel`）。
   - **间接推荐人** = 推荐人的 `referrerId` 对应会员。

3. **依次计算（均以订单金额 `orderAmount = order.totalAmount` 为基数）**

   - **直接佣金**
     - 条件：推荐人的会员等级 `isSharingEarner === true`。
     - 比例：`referrer.personalDirectCommissionRate ?? referrer.memberLevel.directCommissionRate`，若 ≤0 不生成。
     - 金额：`orderAmount * commissionRate / 100`。
     - 接收人：推荐人。

   - **间接佣金**
     - 条件：存在间接推荐人，且其会员等级 `isSharingEarner === true`。
     - 比例：`indirectReferrer.personalIndirectCommissionRate ?? indirectReferrer.memberLevel.indirectCommissionRate`，≤0 不生成。
     - 金额：`orderAmount * commissionRate / 100`。
     - 接收人：间接推荐人。

   - **分销商佣金**
     - 条件：推荐人本人是分销商（`referrer.distributorLevel` 存在）。
     - 成本率：`referrer.personalCostRate ?? referrer.distributorLevel.costRate`，≤0 不生成。
     - 成本额：`orderAmount * costRate / 100`；佣金 = `orderAmount - costAmount`。
     - 接收人：推荐人。

   - **网络分销商佣金**
     - 在推荐人向上整条链中找「最近的一个分销商」`networkDistributor`。
     - 再找该链上除其外的其他分销商 `otherDistributors`。
     - 若只有该分销商：按该分销商成本率算成本额，佣金 = 订单额 - 成本额。
     - 若有多个：取「最近分销商成本率 − 其他分销商中最高成本率」为比例，佣金 = `orderAmount * costDifference / 100`；若差值 ≤0 不生成。
     - 接收人：最近分销商。

4. **落库**
   - 所有上述结果写入表 `commission_calculations`，类型分别为 `direct`、`indirect`、`distributor`、`network_distributor`，状态均为 `pending`。
   - 不写入 `member_commission_records`，也不直接增加会员的 `availableCommission`。

---

## 四、入账与确认

### 4.1 订单佣金入账（CommissionCalculation → 会员余额）

- **计算记录**：仅生成在 `commission_calculations` 中，状态为 `pending`。
- **入账时机**：**需在后台对单条计算记录做「确认」**。
- **接口**：`PUT /api/commission/confirm/:id`（id 为 `CommissionCalculation.id`）。
- **确认后逻辑**（`commissionService.confirmCommission`）：
  - 将计算记录状态改为 `confirmed`。
  - 将 `commissionAmount` 累加到对应用户的 `availableCommission` 和 `totalCommission`。
  - **注意**：当前实现**不会**写入 `member_commission_records` 表，仅更新会员表的佣金字段。

### 4.2 管理员调整（直接改会员佣金）

- **接口**：会员管理相关接口中「调整佣金」（如 `routes/member-routes.js` 中调整会员佣金）。
- **逻辑**：可增可减（类型 `admin_adjust`），同时：
  - 更新会员的 `totalCommission`、`availableCommission`（及必要时 `frozenCommission`）。
  - **会**写入一条 `member_commission_records`，类型为 `admin_adjust`，状态 `completed`。

### 4.3 小结

| 来源 | 是否写 CommissionCalculation | 是否写 MemberCommissionRecord | 何时增加 availableCommission |
|------|-------------------------------|-------------------------------|--------------------------------|
| 订单佣金（直接/间接/分销/网络） | 是（pending → 后台确认） | 否 | 后台确认该条计算记录时 |
| 管理员调整 | 否 | 是 | 调整时立即 |

---

## 五、会员佣金字段与提现

- **availableCommission**：可用佣金，可用于抵扣下单或申请提现。
- **frozenCommission**：冻结佣金，提现申请提交时「可用 → 冻结」，审核通过并打款（或标记完成）时扣减冻结；拒绝或撤销时「冻结 → 可用」。
- **totalCommission**：历史累计总佣金（含已提现、已使用）。

提现流程简述：

1. 用户提交提现：扣减 `availableCommission`，增加 `frozenCommission`。
2. 审核通过（微信）：调用商家转账，扣减 `frozenCommission`（若为银行卡则标记完成时扣减）。
3. 拒绝：`frozenCommission` 减、`availableCommission` 加回。
4. 转账撤回：`frozenCommission` 减、`availableCommission` 加回，提现记录改为已取消。

---

## 六、配置与等级（比例来源）

- **会员等级**（`member_levels`）：  
  `isSharingEarner`、`directCommissionRate`、`indirectCommissionRate`。  
  会员可覆盖：`Member.personalDirectCommissionRate`、`Member.personalIndirectCommissionRate`。

- **分销等级**（`distributor_levels`）：  
  `costRate`（提货成本比例）、`directCommissionRate`、`indirectCommissionRate`。  
  会员可覆盖：`Member.personalCostRate`。

- **团队拓展等级**（`team_expansion_levels`）：  
  `minIncentiveBase`、`maxIncentiveBase`、`incentiveRate`。用于按月计算团队拓展激励，推荐人需绑定该等级（如 `teamExpansionLevelId`）。

---

## 七、相关代码文件

| 文件 | 作用 |
|------|------|
| `services/commissionService.js` | 订单佣金计算、团队拓展激励计算、确认/取消单条计算 |
| `routes/commission-routes.js` | 后台：计算记录列表、手动触发订单/团队激励计算、确认与取消 |
| `routes/miniapp-order-routes.js` | 订单支付成功后调用 `calculateOrderCommission` |
| `routes/member-routes.js` | 会员佣金调整、写 MemberCommissionRecord |
| `routes/withdrawal-routes.js`、`services/withdrawalService.js` | 提现审核、冻结/可用变动、转账撤回 |
| `db.js` | CommissionCalculation、MemberCommissionRecord、Member 佣金字段、MemberLevel、DistributorLevel、TeamExpansionLevel 定义 |

---

## 八、注意事项

1. **订单佣金不会自动到账**：支付后只生成 `commission_calculations` 待确认记录，需后台在「佣金计算」中逐条或批量确认后，才会增加会员 `availableCommission`。
2. **团队拓展激励**：仅手动按月经由 `POST /api/commission/calculate-team-incentive` 计算，且计算结果是 `TeamIncentiveCalculation`，是否以及如何转入会员余额需看业务是否另有实现。
3. **commissionService.calculateMonthlySales** 中使用了 `sequelize.fn`/`sequelize.col`，但 `commissionService.js` 未从 `db` 引入 `sequelize`，若团队拓展激励报错需检查并改为从 `db` 引入 `sequelize` 或使用 `Order.sequelize`。

以上逻辑以当前代码为准，后续若有改动请同步更新本文档。
