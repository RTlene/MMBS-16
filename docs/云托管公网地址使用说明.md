# 云托管公网地址使用说明

当前后台公网访问地址：

**https://express-1tth-223108-8-1373039464.sh.run.tcloudbase.com/**

---

## 一、用作回调链接

支付、授权等需要「回调地址」时，填写：**上述域名 + 接口路径**。

| 用途 | 回调地址示例 |
|------|--------------|
| 微信支付结果通知 | `https://express-1tth-223108-8-1373039464.sh.run.tcloudbase.com/api/payment/wechat/notify` |
| 其他需公网回调的接口 | `https://express-1tth-223108-8-1373039464.sh.run.tcloudbase.com/你的路径` |

注意：

- 必须使用 **HTTPS**，且与云托管实际公网域名一致。
- 微信支付商户号里配置的「支付结果通知 URL」需与上表一致，且云托管服务已部署、可被外网访问。

---

## 二、小程序开发工具如何访问云托管

要让小程序（含开发工具、真机）请求到云托管后台：

1. **配置小程序 API 地址**  
   在 `miniprogram-new/config/api.js` 中：
   - 已将 `PROD_BASE_URL` 设为上述云托管域名。
   - 开发时联调云托管：把 `ENV` 改为 `'production'`，则请求会发到云托管。

2. **配置微信公众平台合法域名**  
   - 登录 [微信公众平台](https://mp.weixin.qq.com/) → 小程序 → 开发 → 开发管理 → 开发设置 → 服务器域名。
   - 在 **request 合法域名** 中增加：  
     `https://express-1tth-223108-8-1373039464.sh.run.tcloudbase.com`  
   - 保存后，开发工具与真机即可请求该域名。

3. **开发工具中联调**  
   - 保持 `ENV = 'production'`，重新编译/预览，即会请求云托管接口。
   - 若需请求本地后端，将 `ENV` 改回 `'development'`，并设置好 `DEV_BASE_URL`。

总结：**回调链接 = 云托管公网域名 + 接口路径**；**小程序访问云托管 = 配置 PROD_BASE_URL + request 合法域名 + 按需切换 ENV**。

---

## 三、获取云托管公网出口 IP（配置商户号白名单用）

微信支付商户平台部分功能（如**商家转账 → 产品设置 → 接口安全 → 设置接口安全 IP**）需要配置「允许调用接口的服务器 IP」，即云托管实例的**公网出口 IP**。

### 方法一：接口查询（推荐）

服务已部署到云托管后，在浏览器访问：

**`https://你的云托管公网域名/api/outbound-ip`**

示例：`https://express-1tth-223108-8-1373039464.sh.run.tcloudbase.com/api/outbound-ip`

返回示例：`{ "code": 0, "outboundIp": "x.x.x.x", "message": "..." }`，其中的 **outboundIp** 即为当前实例的公网出口 IP，填入商户平台「接口安全」中的 IP 白名单即可。

### 方法二：固定公网出口 IP（标准版及以上）

若希望出口 IP 固定、避免实例重启后变化：

1. 登录 [微信云托管控制台](https://console.cloud.tencent.com/tcb)（或腾讯云开发）。
2. 进入对应环境 → **云托管** → 选择服务 → **环境配置 / 版本配置**。
3. 在 **网络 / 固定公网出口 IP** 中开启「固定公网 IP」能力（标准版及以上套餐支持）。
4. 开启后会分配固定出口 IP，在控制台或通过方法一接口均可查看，将该 IP 配置到商户平台。

### 商户平台配置路径参考

- **微信支付商户平台** → 产品中心 → **商家转账** → 前往功能 → **产品设置** → **转账发起方式** → API 发起 → **接口安全** → 添加上述出口 IP。
