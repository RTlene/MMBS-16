# 商家转账（佣金提现）锁定资金退还说明

升级版商家转账采用「用户确认收款」模式：发起转账后资金会先锁定，用户在小程序内确认收款后才会真正打款。若用户一直未确认或你希望取消该笔转账，**锁定的运营金额可以退还**。

---

## 一、退还方式

### 1. 自动退还（无需操作）

- **规则**：从转账单创建成功起算，**用户 24 小时内未确认收款**时，微信会**自动关单并将该笔金额退回商户账户**。
- **说明**：关单可能略晚于 24 小时，可通过「商户单号查询转账单」或「微信单号查询转账单」确认状态是否为终态（如 `CANCELLED`）。

### 2. 主动撤销（立即申请退还）

- **规则**：在**用户确认收款之前**，商户可调用**撤销转账 API** 主动撤销，系统异步处理完成后资金退回商户。
- **接口**（普通商户）：
  - 请求：`POST /v3/fund-app/mch-transfer/transfer-bills/out-bill-no/{out_bill_no}/cancel`
  - 域名：`https://api.mch.weixin.qq.com`
  - 路径参数：`out_bill_no` = 商户单号（即你系统里的提现单号，如 `WD17709965319952178`，需仅含数字与字母）
  - 无请求体，需带签名认证（同发起转账）。
- **响应**：返回成功仅表示撤销请求已受理；最终是否撤销成功需通过「商户单号查询转账单」看 `state` 是否为 `CANCELLED`。
- **终态**：`CANCELLED` 表示已撤销完成，资金已退回商户。

---

## 二、注意事项

1. **仅限“用户未确认”时**：用户已点击确认收款后，微信会执行打款，无法再撤销。
2. **商户单号**：撤销时使用的 `out_bill_no` 必须与发起转账时一致（即你存库的提现单号，过滤为非数字字母时要用同一规则）。
3. **查询**：撤销后建议调用「商户单号查询转账单」确认 `state` 为 `CANCELLED`，再在业务侧将提现状态更新为「已取消」等。

---

## 三、文档与接口索引

- 开发指引（含 24h 自动关单说明）：<https://pay.weixin.qq.com/doc/v3/merchant/4012715211>
- 撤销转账 API（普通商户）：<https://pay.weixin.qq.com/doc/v3/merchant/4012716458>
- 商户单号查询转账单：<https://pay.weixin.qq.com/doc/v3/merchant/4012716437>

---

**结论**：佣金提现失败或用户长期未确认导致资金锁定时，可以退还：要么等约 24 小时系统自动关单退款，要么调用撤销转账 API 主动撤销，资金会退回商户号。

---

## 四、本系统已实现

- **服务层**：`services/wechatPayService.js` 提供 `cancelTransfer(outBillNo)`，调用微信撤销转账接口。
- **业务层**：`services/withdrawalService.js` 提供 `cancelTransfer(withdrawalId)`：校验为微信且已发起转账、调用微信撤销、将提现状态改为已取消、用户佣金加回可用余额、备注「已撤销转账，资金退回」。
- **后台接口**：`POST /api/withdrawals/:id/cancel-transfer`（需登录），对指定提现执行撤销。
- **后台界面**：佣金提现管理 → 点击某条记录查看详情 → 当该笔为微信且已发起转账（已通过/已完成）时，显示「撤销转账」按钮，确认后执行撤销并刷新列表。
