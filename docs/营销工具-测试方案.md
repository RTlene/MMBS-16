# 小程序营销工具测试方案

本文档覆盖优惠券、促销活动、积分商城、抽奖、横幅、弹窗及价格计算等营销相关能力的测试范围、用例与自动化说明。

---

## 一、营销工具范围与入口

| 模块       | 后端路由/接口说明 | 小程序端入口 | 说明 |
|------------|-------------------|--------------|------|
| 优惠券     | `miniapp-coupon-routes` | 个人中心「我的优惠券」、订单确认页选券 | 领取、我的列表、可用/已用/过期、下单抵扣 |
| 促销活动   | `promotion-routes`（管理端）、订单内应用 | 商品详情/订单确认页价格展示 | 满减、折扣等，创建订单时参与计算 |
| 积分商城   | `point-mall-routes`（管理端） | 待完善 | 积分商品、兑换记录，暂无小程序页 |
| 抽奖活动   | `lucky-draw-routes`（管理端） | 待完善 | 活动配置与状态，暂无小程序页 |
| 横幅       | `banner-routes`（含公开接口） | 首页轮播等 | 按 position 获取，公开接口无需登录 |
| 弹窗       | `popup-routes`（含公开接口） | 启动/首页弹窗 | 获取当前生效弹窗，公开接口 |
| 价格计算   | `miniapp-product-routes` 中 `calculate-price` | 订单确认页 | 商品+优惠券+促销+积分一起算价 |

---

## 二、测试环境与前置条件

- **后端**：服务已启动（如 `node index.js`），端口与 `BASE_URL` 一致（默认 `http://localhost:3000`）；云托管部署时使用该服务的**公网访问地址**作为 `BASE_URL` 即可对线上/预发做接口测试。
- **管理后台**：已有管理员账号（如 `admin` / `admin123`），用于获取 Token 调用管理端 API（云托管环境需保证与后台登录账号一致或通过环境变量传入）。
- **小程序**：开发工具中运行 `miniprogram-new`，需能访问后端 `BASE_URL`（开发时可勾选「不校验合法域名」）。
- **数据库**：存在测试用优惠券、促销、横幅、弹窗、积分商品、抽奖活动等（可先通过后台配置或脚本初始化）。

### 测试数据：手工配置 vs 自动化造数

- **当前脚本行为**：自动化脚本只**请求现有接口并做基本断言**（状态码、返回结构、total 等），**不会**自动创建或删除数据，因此是「只读」回归测试。
- **两种用法**：
  1. **手工配置**：测试前在管理后台配置一套运营数据，再跑脚本、做手工用例。
     - 建议至少：1 个上架商品（含 SKU）、1 条横幅（可选）、1 个弹窗（可选）、1 个促销活动（可选）。优惠券目前无管理端 CRUD 页面与接口，需在数据库中直接维护或后续开发管理功能。
     - 适合：正式/预发环境、不想改数据的场景。
  2. **自动化造数（可选）**：可新增「种子脚本」在测试前通过管理端 API 自动创建数据（如 1 条促销、1 条横幅等），跑完测试后可选清理。  
     - 限制：**优惠券**当前无管理端 `/api/coupons` 接口，无法通过接口造数，只能依赖数据库或后续开发管理接口；促销、横幅、弹窗、积分商品、抽奖等有管理端接口，可脚本化创建。
- **种子脚本**：已提供 `scripts/seed-marketing-test-data.js`，会通过管理端登录后自动创建 1 条促销（满99包邮）、1 张优惠券（10 元券，满 50 可用）。运行顺序建议：先执行 `node scripts/seed-marketing-test-data.js`，再执行 `node scripts/test-marketing-api.js` 做接口回归。

---

## 三、功能测试用例（手工 + API）

### 3.1 优惠券

| 用例编号 | 场景 | 操作步骤 | 预期结果 |
|----------|------|----------|----------|
| C01      | 我的优惠券列表（需登录） | 小程序登录后进入「我的优惠券」 | 展示全部/可用/已用/过期 Tab，列表与接口一致 |
| C02      | 可用优惠券筛选 | 切换至「可用」Tab | 仅展示未使用、未过期、有剩余量的券 |
| C03      | 领取优惠券 | 调用 `POST /api/miniapp/coupons/:id/receive`（会员 Token） | 成功则领取成功；已领或达上限返回明确错误 |
| C04      | 下单选券 | 订单确认页选择一张可用券 | 订单金额随优惠变化，提交订单时传入 `appliedCoupons` |
| C05      | 最低订单金额 | 订单未达券的 `minOrderAmount` 时选券 | 该券不可选或提示「未满足最低消费」 |

**涉及接口：**

- `GET /api/miniapp/coupons/my?status=all|available|used|expired&page=1&limit=20`（需小程序会员 Token）
- `GET /api/miniapp/coupons/available`（需会员 Token，下单前可用券）
- `POST /api/miniapp/coupons/:id/receive`（需会员 Token）

### 3.2 促销活动

| 用例编号 | 场景 | 操作步骤 | 预期结果 |
|----------|------|----------|----------|
| P01      | 管理端列表 | 后台「促销管理」列表 | 支持按类型、状态筛选，分页正常 |
| P02      | 创建/编辑促销 | 新增或编辑一条促销（类型、时间、规则） | 保存成功，列表可查 |
| P03      | 订单应用促销 | 创建订单时传入 `appliedPromotions` 或由后端自动匹配 | 订单金额、折扣与规则一致 |
| P04      | 价格计算接口 | `POST /api/miniapp/products/calculate-price` 传入商品、数量、会员、优惠券、促销、积分 | 返回原价、实付、优惠明细、节省比例 |

**涉及接口：**

- 管理端：`GET /api/promotions`、`GET /api/promotions/:id`、`POST /api/promotions`、`PUT /api/promotions/:id`（均需 Admin Token）
- 小程序：`POST /api/miniapp/products/calculate-price`（无需登录，但传 `memberId` 时会影响会员价等）

### 3.3 积分商城

| 用例编号 | 场景 | 操作步骤 | 预期结果 |
|----------|------|----------|----------|
| M01      | 积分商品列表 | 管理端「积分商城」商品列表 | 分页、筛选、排序正常 |
| M02      | 积分兑换（管理端） | 后台发起兑换或查看兑换记录 | 扣减积分、生成记录，状态正确 |
| M03      | 积分设置 | 积分来源配置、比例 | 与订单发放积分、兑换规则一致 |

**涉及接口：**

- `GET /api/point-mall/stats`、`GET /api/point-mall/products`、`GET /api/point-mall/products/:id`（需 Admin Token）
- `POST /api/point-mall/exchange`（管理端兑换，需 Admin Token）

### 3.4 抽奖活动

| 用例编号 | 场景 | 操作步骤 | 预期结果 |
|----------|------|----------|----------|
| L01      | 抽奖列表与状态 | 管理端「抽奖管理」 | 列表、筛选、启用/停用正常 |
| L02      | 活动时间与奖品 | 编辑活动时间、奖品配置 | 保存成功，前端展示与配置一致（若有小程序抽奖页） |

**涉及接口：**

- `GET /api/lucky-draws/stats`、`GET /api/lucky-draws`、`GET /api/lucky-draws/:id`（需 Admin Token）

### 3.5 横幅

| 用例编号 | 场景 | 操作步骤 | 预期结果 |
|----------|------|----------|----------|
| B01      | 公开获取首页横幅 | `GET /api/banners/public/homepage`（无需 Token） | 返回当前有效、position 匹配的横幅列表，按 sort 排序 |
| B02      | 管理端 CRUD | 后台「横幅管理」增删改查、上下架、时间范围 | 列表与公开接口展示一致 |
| B03      | 多 position | 请求 `activity`、`product` 等 | 返回对应 position 的横幅 |

**涉及接口：**

- 公开：`GET /api/banners/public/:position`（如 `homepage`、`activity`）
- 管理端：`GET /api/banners`、`POST /api/banners`、`PUT /api/banners/:id`（需 Admin Token，具体以路由为准）

### 3.6 弹窗

| 用例编号 | 场景 | 操作步骤 | 预期结果 |
|----------|------|----------|----------|
| O01      | 获取当前生效弹窗 | 调用公开接口获取 active 弹窗 | 返回 status=active 且在时间范围内的弹窗 |
| O02      | 管理端 CRUD | 后台「弹窗管理」创建、编辑、启用/停用 | 列表与公开接口一致 |

**涉及接口：**

- 公开：`GET /api/popups/public/active`（当前与整路由一起鉴权，小程序若需未登录获取，需将该路由单独放开或使用可选鉴权）
- 管理端：`GET /api/popups`、`POST /api/popups`、`PUT /api/popups/:id`（需 Admin Token）

### 3.7 价格计算（营销汇总）

| 用例编号 | 场景 | 操作步骤 | 预期结果 |
|----------|------|----------|----------|
| R01      | 仅商品与数量 | `calculate-price` 仅传 productId、skuId、quantity、memberId | 返回原价、实付（含会员价若有） |
| R02      | 叠加优惠券 | 增加 `appliedCoupons` | 实付与优惠明细体现券抵扣 |
| R03      | 叠加促销 | 增加 `appliedPromotions` 或由后端自动应用 | 折扣、满减正确 |
| R04      | 叠加积分 | 传 `pointUsage` | 抵扣金额与积分比例一致，实付正确 |
| R05      | 缺参校验 | 缺少 productId 或 quantity 或 memberId | 返回 400 及明确错误信息 |

---

## 四、自动化测试方案

### 4.1 思路

- 以 **后端 API 自动化** 为主：使用 Node 脚本请求营销相关接口，断言状态码与关键字段，不依赖小程序 IDE。
- 管理端接口：先 `POST /api/auth/login` 取 Token，再带 `Authorization: Bearer <token>` 请求促销、积分商城、抽奖、横幅、弹窗等。
- 公开接口：直接请求横幅公开、弹窗公开（若已放开）、价格计算等，无需 Token。
- 小程序会员接口（如我的优惠券）：需要小程序登录得到的 `memberToken`，脚本中可用测试账号调用 `POST /api/auth/miniapp-login` 获取，再测 `/api/miniapp/coupons/my` 等。

### 4.2 运行方式

- 推荐使用项目内提供的 **Node 脚本** `scripts/test-marketing-api.js`，在项目根目录执行：
  ```bash
  node scripts/test-marketing-api.js
  ```
  可选环境变量：`BASE_URL`（默认 `http://localhost:3000`）、`ADMIN_USERNAME`、`ADMIN_PASSWORD`。
- 脚本依赖现有 `axios`，无需新增测试框架；若后续需要用例组织与报告，可再引入 Jest/Mocha + supertest。

### 4.3 覆盖范围（脚本内）

- 健康检查
- 管理端登录
- **横幅**：GET 公开 ` /api/banners/public/homepage`
- **弹窗**：GET `/api/popups/public/active`（若需 Token 则带 Admin Token）
- **促销**：GET `/api/promotions?page=1&limit=5`
- **优惠券（管理端）**：GET `/api/coupons?page=1&limit=5`
- **积分商城**：GET `/api/point-mall/products?page=1&limit=5`
- **抽奖**：GET `/api/lucky-draws?page=1&limit=5`
- **价格计算**：POST `/api/miniapp/products/calculate-price`（示例 body：productId、quantity、memberId 等）
- （可选）小程序登录 + GET 我的优惠券

运行前请确保后端已启动、数据库可连，且管理员账号与 `.env` 一致。

### 4.4 对云托管部署环境的测试

**可以。** 脚本通过 HTTP 请求被测服务，不依赖“跑在服务器本机”，只要执行脚本的机器能访问云托管公网地址即可。

- **推荐做法**：在**本地或 CI 环境**执行脚本，将 `BASE_URL` 指向云托管的公网地址（如 `https://your-service-xxx.bspapp.com` 或云托管提供的访问域名），例如：
  ```bash
  BASE_URL=https://你的云托管公网地址 node scripts/test-marketing-api.js
  ```
  或设置环境变量 `ADMIN_USERNAME`、`ADMIN_PASSWORD` 与云托管环境中的管理员账号一致。
- **说明**：脚本是“从外向里”请求 API，不要求在云托管容器内执行；云托管容器通常只跑主进程（如 `node index.js`），一般不在此内跑一次性测试脚本。若需在集群内定时探测，可单独起一个定时任务/Job，对公网地址发起相同请求。
- **注意**：云托管若配置了仅内网访问或未开放管理端登录接口，需先确认公网可访问、且 `/api/auth/login` 可用（或按实际鉴权方式调整脚本）。

---

## 五、小程序端手工检查清单（营销相关）

- [ ] 首页：横幅轮播展示正确，点击跳转（若有链接）正常。
- [ ] 启动/首页：弹窗在配置时间内展示，关闭后不再重复出现（按业务逻辑）。
- [ ] 个人中心：入口「我的优惠券」进入列表，Tab 与状态筛选正确。
- [ ] 订单确认页：可选优惠券、金额随选券变化；未达最低消费的券不可选或提示明确。
- [ ] 订单确认页：价格与后端 `calculate-price` 一致（含会员价、促销、积分抵扣）。
- [ ] 积分商城、抽奖：若已上线对应页面，则按上述用例做一次完整流程。

---

## 六、与现有文档的关系

- **API 明细**：可参考 `API_TEST_GUIDE.md` 中的路径与参数。
- **佣金/订单**：营销与订单、佣金独立；佣金测试见 `docs/佣金计算-测试方案.md`（若有）。
- 本方案侧重 **营销能力** 的接口与场景，可与整体回归测试一起执行。

---

**文档版本**：1.0  
**最后更新**：按项目需要维护
