<!--pages/order-detail/order-detail.wxml-->
<view class="order-detail-page">
  <!-- åŠ è½½ä¸­ -->
  <view class="loading" wx:if="{{loading}}">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view class="error-state" wx:if="{{error && !loading}}">
    <text class="error-icon">âš ï¸</text>
    <text class="error-text">{{error}}</text>
    <button class="retry-btn" bindtap="loadOrderDetail">é‡è¯•</button>
  </view>

  <!-- è®¢å•è¯¦æƒ… -->
  <scroll-view class="order-content" scroll-y wx:if="{{order && !loading}}">
    <!-- è®¢å•çŠ¶æ€ -->
    <view class="status-section">
      <view class="status-icon">
        <text class="status-emoji">{{order.status === 'pending' ? 'â°' : order.status === 'paid' ? 'ğŸ“¦' : order.status === 'shipped' ? 'ğŸšš' : (order.status === 'delivered' || order.status === 'completed') ? 'âœ…' : 'âŒ'}}</text>
      </view>
      <text class="status-text">{{order.statusText}}</text>
      <text class="order-no">è®¢å•å·ï¼š{{order.orderNo}}</text>
    </view>

    <!-- æ”¶è´§ä¿¡æ¯ -->
    <view class="address-section" wx:if="{{order.receiverName}}">
      <view class="section-title">æ”¶è´§ä¿¡æ¯</view>
      <view class="address-card">
        <view class="address-row">
          <text class="receiver-name">{{order.receiverName}}</text>
          <text class="receiver-phone">{{order.receiverPhone}}</text>
        </view>
        <text class="address-text">{{order.shippingAddress}}</text>
      </view>
    </view>

    <!-- å•†å“åˆ—è¡¨ -->
    <view class="items-section">
      <view class="section-title">å•†å“ä¿¡æ¯</view>
      <view 
        class="item-card"
        wx:for="{{order.items}}"
        wx:key="id"
      >
        <image 
          class="item-image" 
          src="{{item.image}}" 
          mode="aspectFill"
          wx:if="{{item.image && !item.imageLoading}}"
        />
        <view class="item-image-placeholder" wx:else>
          <text class="placeholder-text">ğŸ“¦</text>
        </view>
        <view class="item-info">
          <text class="item-name">{{item.productName}}</text>
          <text class="item-sku" wx:if="{{item.skuName}}">{{item.skuName}}</text>
          <view class="item-meta">
            <text class="item-price">Â¥{{item.unitPrice}}</text>
            <text class="item-qty">x{{item.quantity}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ ¸é”€ç åˆ—è¡¨ -->
    <view class="verification-section" wx:if="{{verificationCodes.length > 0}}">
      <view class="section-title">æ ¸é”€ç </view>
      <view class="verification-card">
        <view 
          class="verification-item"
          wx:for="{{verificationCodes}}"
          wx:key="id"
        >
          <!-- å•†å“ä¿¡æ¯ -->
          <view class="verification-product" wx:if="{{item.productName}}">
            <text class="product-name">{{item.productName}}</text>
            <text class="sku-name" wx:if="{{item.skuName}}">{{item.skuName}}</text>
          </view>
          
          <!-- äºŒç»´ç  -->
          <view class="verification-qrcode" wx:if="{{item.qrCodePath}}">
            <image class="qrcode-image" src="{{item.qrCodePath}}" mode="aspectFit" />
            <text class="qrcode-label">äºŒç»´ç </text>
          </view>
          
          <!-- æ¡å½¢ç  -->
          <view class="verification-barcode" wx:if="{{item.barcodePath}}">
            <image class="barcode-image" src="{{item.barcodePath}}" mode="widthFix" />
            <text class="barcode-label">æ¡å½¢ç </text>
          </view>
          
          <!-- æ ¸é”€ç æ–‡æœ¬ -->
          <view class="verification-code">
            <text class="code-label">æ ¸é”€ç ï¼š</text>
            <text class="code-value">{{item.code}}</text>
            <text class="copy-btn" data-code="{{item.code}}" catchtap="onCopyVerificationCode">å¤åˆ¶</text>
          </view>
          
          <!-- çŠ¶æ€ä¿¡æ¯ -->
          <view class="verification-status">
            <text class="status-text status-{{item.status}}">{{item.statusText}}</text>
            <text class="expired-text" wx:if="{{item.expiredAt}}">æœ‰æ•ˆæœŸè‡³ï¼š{{item.expiredAt}}</text>
            <text class="used-text" wx:if="{{item.usedAt}}">ä½¿ç”¨æ—¶é—´ï¼š{{item.usedAt}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- è®¢å•ä¿¡æ¯ -->
    <view class="info-section">
      <view class="section-title">è®¢å•ä¿¡æ¯</view>
      <view class="info-card">
        <view class="info-row">
          <text class="info-label">è®¢å•é‡‘é¢</text>
          <text class="info-value price">{{order.totalAmountText}}</text>
        </view>
        <view class="info-row" wx:if="{{order.paymentMethodText}}">
          <text class="info-label">æ”¯ä»˜æ–¹å¼</text>
          <text class="info-value">{{order.paymentMethodText}}</text>
        </view>
        <view class="info-row" wx:if="{{order.createdAtText}}">
          <text class="info-label">ä¸‹å•æ—¶é—´</text>
          <text class="info-value">{{order.createdAtText}}</text>
        </view>
        <view class="info-row" wx:if="{{order.returnStatusText && order.returnStatus !== 'none'}}">
          <text class="info-label">é€€è´§çŠ¶æ€</text>
          <text class="info-value">{{order.returnStatusText}}</text>
        </view>
        <view class="info-row" wx:if="{{order.refundStatusText && order.refundStatus !== 'none'}}">
          <text class="info-label">é€€æ¬¾çŠ¶æ€</text>
          <text class="info-value">{{order.refundStatusText}}</text>
        </view>
        <view class="info-row" wx:if="{{order.shippingCompany || order.trackingNumber}}">
          <text class="info-label">ç‰©æµä¿¡æ¯</text>
          <view class="info-value-wrapper">
            <text class="info-value" wx:if="{{order.shippingCompany}}">{{order.shippingCompany}}</text>
            <text class="info-value" wx:if="{{order.trackingNumber}}"> {{order.trackingNumber}}</text>
            <text class="logistics-link" bindtap="onViewLogistics" wx:if="{{order.trackingNumber || order.shippingCompany}}">æŸ¥çœ‹ç‰©æµ â€º</text>
          </view>
        </view>
        <view class="info-row" wx:if="{{order.remark}}">
          <text class="info-label">è®¢å•å¤‡æ³¨</text>
          <text class="info-value">{{order.remark}}</text>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨æ“ä½œæ ï¼šæœªå‘è´§å¯ç”³è¯·é€€æ¬¾ï¼Œå·²å‘è´§/å·²æ”¶è´§å¯ç”³è¯·é€€è´§ -->
  <view class="bottom-bar" wx:if="{{order && !loading}}">
    <view class="bottom-bar-hint" wx:if="{{order.status === 'paid' || order.status === 'shipped' || order.status === 'delivered'}}">
      <text wx:if="{{order.status === 'paid'}}">æœªå‘è´§å¯ç›´æ¥ç”³è¯·é€€æ¬¾</text>
      <text wx:elif="{{order.status === 'shipped' || order.status === 'delivered'}}">å·²å‘è´§/å·²æ”¶è´§å¯ç”³è¯·é€€è´§ï¼ˆæ¢è´§è¯·åœ¨é€€è´§åŸå› ä¸­è¯´æ˜ï¼‰</text>
    </view>
    <button
      class="action-btn primary"
      wx:if="{{order.status === 'pending'}}"
      bindtap="onPayOrder"
    >
      ç«‹å³æ”¯ä»˜
    </button>
    <button
      class="action-btn secondary"
      wx:if="{{order.status === 'pending'}}"
      bindtap="onCancelOrder"
    >
      å–æ¶ˆè®¢å•
    </button>
    <button
      class="action-btn primary"
      wx:if="{{order.status === 'shipped'}}"
      bindtap="onConfirmReceive"
    >
      ç¡®è®¤æ”¶è´§
    </button>
    <!-- å·²å‘è´§/å·²æ”¶è´§ï¼šç”³è¯·é€€è´§ï¼ˆå«æ¢è´§è¯´æ˜ï¼‰ -->
    <button
      class="action-btn secondary"
      wx:if="{{(order.status === 'delivered' || order.status === 'shipped') && (!order.returnStatus || order.returnStatus === 'none')}}"
      bindtap="onRequestReturn"
    >
      ç”³è¯·é€€è´§/æ¢è´§
    </button>
    <!-- æœªå‘è´§å¯é€€æ¬¾ï¼›å·²å–æ¶ˆ/å·²é€€è´§/é€€è´§é€šè¿‡åå¯ç”³è¯·é€€æ¬¾ -->
    <button
      class="action-btn secondary"
      wx:if="{{((order.status === 'paid' || order.status === 'cancelled' || order.status === 'returned') || order.returnStatus === 'approved') && (!order.refundStatus || order.refundStatus === 'none')}}"
      bindtap="onRequestRefund"
    >
      ç”³è¯·é€€æ¬¾
    </button>
  </view>
</view>
