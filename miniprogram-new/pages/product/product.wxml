<!--pages/product/product.wxml-->
<view class="product-page">
  
  <!-- å•†å“å›¾ç‰‡+è§†é¢‘è½®æ’­ï¼ˆä¸»å›¾åœ¨å‰ï¼Œæ»‘åˆ°æœ€åä¸ºè§†é¢‘ï¼‰ -->
  <swiper 
    class="product-swiper"
    indicator-dots="{{true}}"
    indicator-color="rgba(0, 0, 0, 0.3)"
    indicator-active-color="#FFFFFF"
    bindchange="onImageChange"
    wx:if="{{carouselItems.length}}"
  >
    <swiper-item wx:for="{{carouselItems}}" wx:key="index" bindtap="onImageTap">
      <image wx:if="{{item.type === 'image'}}" class="product-image" src="{{item.url}}" mode="aspectFill" />
      <video 
        wx:elif="{{item.type === 'video'}}" 
        class="product-video-swiper" 
        src="{{item.url}}" 
        controls 
        show-center-play-btn="{{true}}"
        object-fit="contain"
      />
    </swiper-item>
  </swiper>
  <view class="empty-gallery" wx:elif="{{productBasic}}">
    æš‚æ— ä¸»å›¾
  </view>

  <scroll-view class="product-content" scroll-y>
    <!-- ä»·æ ¼å’Œæ ‡é¢˜ -->
    <view class="product-header" wx:if="{{productBasic}}">
      <view class="price-section">
        <view class="current-price">
          <text class="price-symbol">Â¥</text>
          <text class="price-value">{{finalPrice}}</text>
        </view>
        <view class="original-price" wx:if="{{productBasic.originalPrice > finalPrice}}">
          Â¥{{productBasic.originalPrice}}
        </view>
      </view>
      
      <view class="product-title">{{productBasic.name}}</view>
      <view class="product-subtitle" wx:if="{{productBasic.description}}">
        {{productBasic.description}}
      </view>
      
      <!-- ä¼˜æƒ ä¿¡æ¯ -->
      <view class="discount-info" wx:if="{{discountInfo}}">
        <text class="discount-tag">ä¼˜æƒ </text>
        <text class="discount-text">{{discountInfo.description}}</text>
      </view>
    </view>

    <!-- ä¿ƒé”€æ´»åŠ¨ -->
    <view class="promotion-section" wx:if="{{promotions.length > 0}}">
      <view class="section-title">ä¿ƒé”€æ´»åŠ¨</view>
      <view class="promotion-list">
        <view class="promotion-item" wx:for="{{promotions}}" wx:key="id">
          <text class="promotion-tag">{{item.type}}</text>
          <text class="promotion-desc">{{item.description}}</text>
        </view>
      </view>
    </view>

    <!-- ä¼˜æƒ åˆ¸ -->
    <view class="coupon-section" wx:if="{{coupons.length > 0}}" bindtap="onViewCoupons">
      <view class="section-title">ä¼˜æƒ åˆ¸</view>
      <view class="coupon-list">
        <view class="coupon-item" wx:for="{{coupons}}" wx:key="id">
          <text class="coupon-value">Â¥{{item.value}}</text>
          <text class="coupon-name">{{item.name}}</text>
        </view>
        <text class="coupon-more">â€º</text>
      </view>
    </view>

    <!-- è§„æ ¼é€‰æ‹© -->
    <view class="sku-section" wx:if="{{productBasic}}" bindtap="showSkuSelector">
      <view class="section-title">é€‰æ‹©è§„æ ¼</view>
      <view class="sku-selected">
        <text class="sku-text">{{selectedSku ? selectedSku.name : 'è¯·é€‰æ‹©è§„æ ¼'}}</text>
        <text class="sku-arrow">â€º</text>
      </view>
    </view>

    <!-- å•†å“è¯¦æƒ…ï¼ˆè§†é¢‘å·²æ”¾åœ¨é¡¶éƒ¨è½®æ’­ä¸­ï¼Œä¸»å›¾åï¼‰ -->
    <view class="detail-section" wx:if="{{productBasic}}">
      <view class="section-title">å•†å“è¯¦æƒ…</view>
      <view class="detail-content">
        <image 
          wx:for="{{detailImages}}" 
          wx:key="index"
          class="detail-image" 
          src="{{item}}" 
          lazy-load="true"
          mode="widthFix"
        />
        <view class="detail-text" wx:if="{{detailImages.length === 0}}">
          {{productBasic.description || 'æš‚æ— è¯¦æƒ…'}}
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- å®ä½“å•†å“åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar" wx:if="{{productBasic && productBasic.productType !== 'service'}}">
    <view class="bar-left">
      <view class="bar-btn" bindtap="onGoHome">
        <text class="bar-icon">ğŸ </text>
        <text class="bar-text">é¦–é¡µ</text>
      </view>
      <view class="bar-btn" bindtap="onGoCart">
        <text class="bar-icon">ğŸ›’</text>
        <text class="bar-text">è´­ç‰©è½¦</text>
        <view class="cart-badge" wx:if="{{cartCount > 0}}">{{cartCount}}</view>
      </view>
      <view class="bar-btn" bindtap="onContact">
        <text class="bar-icon">ğŸ’¬</text>
        <text class="bar-text">å®¢æœ</text>
      </view>
    </view>
    <view class="bar-right">
      <button class="add-cart-btn" bindtap="showSkuSelector" data-action="cart">åŠ å…¥è´­ç‰©è½¦</button>
      <button class="buy-now-btn" bindtap="showSkuSelector" data-action="buy">ç«‹å³è´­ä¹°</button>
    </view>
  </view>

  <!-- æœåŠ¡å•†å“åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar" wx:if="{{productBasic && productBasic.productType === 'service'}}">
    <view class="bar-left">
      <view class="bar-btn" bindtap="onGoHome">
        <text class="bar-icon">ğŸ </text>
        <text class="bar-text">é¦–é¡µ</text>
      </view>
      <view class="bar-btn" bindtap="onContact">
        <text class="bar-icon">ğŸ’¬</text>
        <text class="bar-text">å®¢æœ</text>
      </view>
    </view>
    <view class="bar-right">
      <button class="buy-now-btn service-buy-btn" bindtap="showSkuSelector" data-action="buy">ç«‹å³è´­ä¹°</button>
    </view>
  </view>

  <!-- SKUé€‰æ‹©å¼¹çª— -->
  <view class="sku-popup {{showSkuPopup ? 'show' : ''}}" wx:if="{{productBasic}}">
    <view class="popup-mask" bindtap="hideSkuSelector"></view>
    <view class="popup-content">
      <!-- å•†å“ä¿¡æ¯ -->
      <view class="popup-header">
        <image class="popup-image" src="{{carouselImages[0] || ''}}" mode="aspectFill" />
        <view class="popup-info">
          <view class="popup-price">Â¥{{finalPrice}}</view>
          <view class="popup-stock">åº“å­˜ï¼š{{selectedSku ? selectedSku.stock : productBasic.stock}}</view>
        </view>
        <text class="popup-close" bindtap="hideSkuSelector">âœ•</text>
      </view>

      <!-- SKUé€‰æ‹© -->
      <view class="sku-list">
        <view class="sku-title">é€‰æ‹©è§„æ ¼</view>
        <view class="sku-options">
          <view 
            class="sku-option {{selectedSku && selectedSku.id === item.id ? 'selected' : ''}}"
            wx:for="{{skus}}"
            wx:key="id"
            bindtap="onSkuSelect"
            data-index="{{index}}"
          >
            {{item.name}}
          </view>
        </view>
      </view>

      <!-- æ•°é‡é€‰æ‹© -->
      <view class="quantity-selector">
        <text class="quantity-title">æ•°é‡</text>
        <view class="quantity-controls">
          <view class="quantity-btn" bindtap="onQuantityDecrease">-</view>
          <input 
            class="quantity-input" 
            type="number" 
            value="{{quantity}}"
            bindinput="onQuantityInput"
          />
          <view class="quantity-btn" bindtap="onQuantityIncrease">+</view>
        </view>
      </view>

      <!-- ç¡®è®¤æŒ‰é’® -->
      <view class="popup-footer">
        <button
          class="confirm-btn {{(productBasic.productType === 'service' || skuAction === 'buy') ? 'buy-btn' : 'cart-btn'}}"
          bindtap="{{(productBasic.productType === 'service' || skuAction === 'buy') ? 'onBuyNow' : 'onAddToCart'}}"
        >
          <text class="btn-text">{{(productBasic.productType === 'service' || skuAction === 'buy') ? 'ç«‹å³è´­ä¹°' : 'åŠ å…¥è´­ç‰©è½¦'}}</text>
        </button>
      </view>
    </view>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view class="loading-mask" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- æµ®åŠ¨åˆ†äº«æŒ‰é’®ï¼ˆå°åœ†å½¢ï¼‰ -->
  <button class="share-button" open-type="share" hover-class="share-button-hover">
    <text class="share-icon">ğŸ“¤</text>
  </button>
</view>

