<!--pages/order-confirm/order-confirm.wxml-->
<view class="order-confirm-page">
  <!-- é…é€æ–¹å¼ -->
  <view class="section-block delivery-type-block">
    <view class="block-title">
      <text class="block-title-icon">ğŸšš</text>
      <text class="block-title-text">é…é€æ–¹å¼</text>
    </view>
    <view class="delivery-type-card">
      <view 
        class="delivery-option {{deliveryType === 'delivery' ? 'active' : ''}}"
        data-type="delivery"
        bindtap="onDeliveryTypeChange"
      >
        <text class="option-label">é…é€ä¸Šé—¨</text>
        <text class="option-desc">å¿«é€’é…é€åˆ°å®¶</text>
      </view>
      <view 
        class="delivery-option {{deliveryType === 'pickup' ? 'active' : ''}}"
        data-type="pickup"
        bindtap="onDeliveryTypeChange"
      >
        <text class="option-label">é—¨åº—è‡ªæ</text>
        <text class="option-desc">åˆ°åº—è‡ªæ</text>
      </view>
    </view>
  </view>

  <!-- æ”¶è´§ä¿¡æ¯ï¼ˆä»…é…é€ä¸Šé—¨æ˜¾ç¤ºï¼‰ -->
  <view class="section-block address-block" wx:if="{{deliveryType === 'delivery'}}">
    <view class="block-title">
      <text class="block-title-icon">ğŸ“</text>
      <text class="block-title-text">æ”¶è´§ä¿¡æ¯</text>
    </view>
    <view class="address-card">
      <view class="field choose-address" bindtap="onChooseSavedAddress">
        <text class="choose-text">{{selectedAddressId ? 'æ›´æ¢å·²ä¿å­˜åœ°å€' : 'é€‰æ‹©å·²ä¿å­˜åœ°å€'}}</text>
        <text class="choose-arrow">â€º</text>
      </view>
      <view class="field">
        <text class="field-label">æ”¶è´§äºº</text>
        <input 
          class="field-input"
          placeholder="è¯·è¾“å…¥æ”¶è´§äººå§“å"
          value="{{receiverName}}"
          data-field="receiverName"
          bindinput="onInputChange"
        />
      </view>
      <view class="field">
        <text class="field-label">æ‰‹æœºå·</text>
        <input 
          class="field-input"
          placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯"
          value="{{receiverPhone}}"
          data-field="receiverPhone"
          bindinput="onInputChange"
          type="number"
          maxlength="11"
        />
      </view>
      <view class="field multi-line">
        <text class="field-label">æ”¶è´§åœ°å€</text>
        <textarea
          class="field-textarea"
          placeholder="è¯·è¾“å…¥è¯¦ç»†æ”¶è´§åœ°å€"
          value="{{shippingAddress}}"
          data-field="shippingAddress"
          bindinput="onInputChange"
          auto-height
        />
      </view>
      <view class="field map-choose-row">
        <text class="field-label">åœ°å›¾é€‰å€</text>
        <button class="map-btn" size="mini" bindtap="onChooseLocation">é€‰ç‚¹</button>
      </view>
    </view>
  </view>

  <!-- è‡ªæé—¨åº—ï¼ˆä»…é—¨åº—è‡ªææ˜¾ç¤ºï¼‰ -->
  <view class="section-block store-block" wx:if="{{deliveryType === 'pickup'}}">
    <view class="block-title">
      <text class="block-title-icon">ğŸª</text>
      <text class="block-title-text">è‡ªæé—¨åº—</text>
    </view>
    <view class="store-card" bindtap="onShowStorePicker">
      <view class="store-selected" wx:if="{{selectedStore}}">
        <text class="store-name">{{selectedStore.name}}</text>
        <text class="store-address">{{selectedStore.address}}</text>
        <text class="store-distance" wx:if="{{selectedStore.distance != null}}">çº¦ {{selectedStore.distance}} km</text>
        <view class="store-actions">
          <text class="store-action-link" catchtap="onOpenStoreMap" data-store="{{selectedStore}}">æŸ¥çœ‹åœ°å›¾</text>
          <text class="store-action-link" catchtap="onOpenExternalMap" data-store="{{selectedStore}}">æ‰“å¼€å¤–éƒ¨åœ°å›¾</text>
        </view>
      </view>
      <view class="store-choose-placeholder" wx:else>
        <text class="choose-text">è¯·é€‰æ‹©è‡ªæé—¨åº—</text>
        <text class="choose-arrow">â€º</text>
      </view>
    </view>
  </view>

  <!-- å•†å“åˆ—è¡¨ -->
  <view class="section-block items-section">
    <view class="block-title">
      <text class="block-title-icon">ğŸ›’</text>
      <text class="block-title-text">å•†å“ä¿¡æ¯</text>
    </view>
    <view class="items-card">
    <view 
      class="item-card"
      wx:for="{{items}}"
      wx:key="skuId"
    >
      <image class="item-image" src="{{item.image}}" mode="aspectFill" />
      <view class="item-info">
        <text class="item-name">{{item.name}}</text>
        <text class="item-sku" wx:if="{{item.skuName}}">{{item.skuName}}</text>
        <view class="item-meta">
          <text class="item-price">Â¥{{item.price}}</text>
          <text class="item-qty">x{{item.quantity}}</text>
        </view>
      </view>
    </view>
    </view>
  </view>

  <!-- ä»·æ ¼æ˜ç»† -->
  <view class="section-block summary-section">
    <view class="block-title">
      <text class="block-title-icon">ğŸ’°</text>
      <text class="block-title-text">è®¢å•æ˜ç»†</text>
    </view>
    <view class="summary-card">
    <view class="summary-row">
      <text class="summary-label">å•†å“åˆè®¡</text>
      <text class="summary-value">Â¥{{originalAmount}}</text>
    </view>
    
    <!-- ä¼˜æƒ åˆ¸é€‰æ‹© -->
    <view class="summary-row coupon-row" bindtap="onShowCouponPicker">
      <view class="coupon-left">
        <text class="summary-label">ä¼˜æƒ åˆ¸</text>
        <text class="coupon-desc" wx:if="{{selectedCoupon}}">{{selectedCoupon.name}}</text>
        <text class="coupon-desc placeholder" wx:else>é€‰æ‹©ä¼˜æƒ åˆ¸</text>
      </view>
      <view class="coupon-right">
        <text class="coupon-discount" wx:if="{{selectedCoupon && discountAmount > 0}}">-Â¥{{discountAmount}}</text>
        <text class="coupon-arrow">></text>
      </view>
    </view>
    
    <!-- ä½£é‡‘æŠµæ‰£ -->
    <view class="summary-row deduction-row">
      <view class="deduction-left">
        <text class="summary-label">ä½£é‡‘æŠµæ‰£</text>
        <text class="deduction-desc" wx:if="{{availableCommission > 0}}">å¯ç”¨ï¼šÂ¥{{availableCommission}}</text>
        <text class="deduction-desc placeholder" wx:else>æš‚æ— å¯ç”¨ä½£é‡‘</text>
      </view>
      <view class="deduction-right">
        <switch 
          checked="{{useCommission > 0}}" 
          bindchange="onToggleCommission"
          disabled="{{availableCommission <= 0 || totalAmount <= 0}}"
          color="#ff6b35"
        />
        <text class="deduction-amount" wx:if="{{useCommission > 0}}">-Â¥{{commissionDeduction}}</text>
      </view>
    </view>
    <view class="deduction-input-row" wx:if="{{useCommission > 0}}">
      <text class="deduction-input-label">ä½¿ç”¨ä½£é‡‘ï¼š</text>
      <input 
        class="deduction-input"
        type="digit"
        placeholder="è¯·è¾“å…¥ä½¿ç”¨é‡‘é¢"
        value="{{useCommission}}"
        bindinput="onCommissionInput"
      />
      <text class="deduction-input-unit">å…ƒ</text>
    </view>
    
    <!-- ç§¯åˆ†æŠµæ‰£ -->
    <view class="summary-row deduction-row">
      <view class="deduction-left">
        <text class="summary-label">ç§¯åˆ†æŠµæ‰£</text>
        <text class="deduction-desc" wx:if="{{availablePoints > 0}}">å¯ç”¨ï¼š{{availablePoints}}ç§¯åˆ†</text>
        <text class="deduction-desc placeholder" wx:else>æš‚æ— å¯ç”¨ç§¯åˆ†</text>
      </view>
      <view class="deduction-right">
        <switch 
          checked="{{usePoints > 0}}" 
          bindchange="onTogglePoints"
          disabled="{{availablePoints <= 0 || totalAmount <= 0}}"
          color="#ff6b35"
        />
        <text class="deduction-amount" wx:if="{{usePoints > 0}}">-Â¥{{pointsDeduction}}</text>
      </view>
    </view>
    <view class="deduction-input-row" wx:if="{{usePoints > 0}}">
      <text class="deduction-input-label">ä½¿ç”¨ç§¯åˆ†ï¼š</text>
      <input 
        class="deduction-input"
        type="number"
        placeholder="è¯·è¾“å…¥ä½¿ç”¨ç§¯åˆ†"
        value="{{usePoints}}"
        bindinput="onPointsInput"
      />
      <text class="deduction-input-unit">ç§¯åˆ†ï¼ˆ100ç§¯åˆ†=1å…ƒï¼‰</text>
    </view>
    
    <!-- ä»·æ ¼æ˜ç»† -->
    <view class="price-detail" wx:if="{{discountAmount > 0 || commissionDeduction > 0 || pointsDeduction > 0}}">
      <view class="detail-row">
        <text class="detail-label">åŸä»·</text>
        <text class="detail-value">Â¥{{originalAmount}}</text>
      </view>
      <view class="detail-row discount-row" wx:if="{{discountAmount > 0}}">
        <text class="detail-label">ä¼˜æƒ åˆ¸</text>
        <text class="detail-value discount">-Â¥{{discountAmount}}</text>
      </view>
      <view class="detail-row discount-row" wx:if="{{commissionDeduction > 0}}">
        <text class="detail-label">ä½£é‡‘æŠµæ‰£</text>
        <text class="detail-value discount">-Â¥{{commissionDeduction}}</text>
      </view>
      <view class="detail-row discount-row" wx:if="{{pointsDeduction > 0}}">
        <text class="detail-label">ç§¯åˆ†æŠµæ‰£</text>
        <text class="detail-value discount">-Â¥{{pointsDeduction}}</text>
      </view>
    </view>
    
    <view class="remark-row">
      <text class="remark-label">è®¢å•å¤‡æ³¨</text>
      <textarea
        class="remark-input"
        placeholder="é€‰å¡«ï¼Œå¦‚é…é€æ—¶é—´ã€å£å‘³ç­‰"
        value="{{remark}}"
        data-field="remark"
        bindinput="onInputChange"
      />
    </view>
    </view>
  </view>

  <!-- ä¼˜æƒ åˆ¸é€‰æ‹©å¼¹çª— -->
  <view class="coupon-picker-mask" wx:if="{{showCouponPicker}}" bindtap="onHideCouponPicker">
    <view class="coupon-picker" catchtap="stopPropagation">
      <view class="picker-header">
        <text class="picker-title">é€‰æ‹©ä¼˜æƒ åˆ¸</text>
        <text class="picker-close" bindtap="onHideCouponPicker">Ã—</text>
      </view>
      <scroll-view class="picker-content" scroll-y>
        <view 
          class="coupon-item {{selectedCoupon && (selectedCoupon.id === item.id || selectedCoupon.id == item.id) ? 'selected' : ''}}"
          wx:for="{{availableCoupons}}"
          wx:key="id"
          bindtap="onSelectCoupon"
          data-coupon="{{item}}"
          data-id="{{item.id}}"
        >
          <view class="coupon-info">
            <text class="coupon-name">{{item.name}}</text>
            <text class="coupon-desc">ä½¿ç”¨é—¨æ§›ï¼š{{item.thresholdText || item.description || 'æ— é—¨æ§›'}}</text>
            <text class="coupon-time" wx:if="{{item.validRange}}">æœ‰æ•ˆæœŸï¼š{{item.validRange}}</text>
          </view>
          <view class="coupon-action">
            <text class="coupon-discount-value">{{item.displayValue}}</text>
            <text class="coupon-tap-hint" wx:if="{{selectedCoupon && (selectedCoupon.id === item.id || selectedCoupon.id == item.id)}}">ç‚¹å‡»å–æ¶ˆ</text>
          </view>
        </view>
        <view class="no-coupon" wx:if="{{availableCoupons.length === 0}}">
          <text class="no-coupon-text">æš‚æ— å¯ç”¨çš„ä¼˜æƒ åˆ¸</text>
        </view>
      </scroll-view>
      <view class="picker-footer" wx:if="{{selectedCoupon}}">
        <button class="remove-coupon-btn" bindtap="onRemoveCoupon">ä¸ä½¿ç”¨ä¼˜æƒ åˆ¸</button>
      </view>
    </view>
  </view>

  <!-- é—¨åº—é€‰æ‹©å¼¹çª— -->
  <view class="store-picker-mask" wx:if="{{showStorePicker}}" bindtap="onHideStorePicker">
    <view class="store-picker" catchtap="stopPropagation">
      <view class="picker-header">
        <text class="picker-title">é€‰æ‹©è‡ªæé—¨åº—</text>
        <text class="picker-close" bindtap="onHideStorePicker">Ã—</text>
      </view>
      <scroll-view class="store-picker-list" scroll-y>
        <view 
          class="store-picker-item {{selectedStore && selectedStore.id === item.id ? 'selected' : ''}}"
          wx:for="{{storeList}}"
          wx:key="id"
          bindtap="onSelectStore"
          data-store="{{item}}"
        >
          <view class="store-item-main">
            <text class="store-item-name">{{item.name}}</text>
            <text class="store-item-address">{{item.address}}</text>
            <text class="store-item-distance" wx:if="{{item.distance != null}}">çº¦ {{item.distance}} km</text>
          </view>
          <view class="store-item-actions">
            <text class="store-item-btn" catchtap="onOpenStoreMap" data-store="{{item}}">åœ°å›¾</text>
            <text class="store-item-btn" catchtap="onOpenExternalMap" data-store="{{item}}">å¤–éƒ¨åœ°å›¾</text>
          </view>
        </view>
        <view class="no-store" wx:if="{{storeList.length === 0}}">
          <text>æš‚æ— å¯é€‰è‡ªæé—¨åº—</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar">
    <view class="total-info">
      <text class="total-label">åˆè®¡ï¼š</text>
      <text class="total-amount">Â¥{{totalAmount}}</text>
    </view>
    <button
      class="submit-btn"
      bindtap="onSubmitOrder"
      loading="{{submitting}}"
      disabled="{{submitting}}"
    >
      æäº¤è®¢å•
    </button>
  </view>
</view>


